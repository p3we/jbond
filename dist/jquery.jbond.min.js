var jbond=function(t){function e(){var t=Error.apply(this,arguments);this.name="RuleError",this.message=t.message,this.stack=t.stack}function i(){var t=Error.apply(this,arguments);this.name="SchemaError",this.message=t.message,this.stack=t.stack}function r(e){this.options=t.extend({validate:!0},e)}function n(e){this.options=t.extend({namespace:"jbond",RuleParser:r},e),this.ruleParser=new this.options.RuleParser({validate:!1})}function s(t){n.call(this,t)}function o(t){n.call(this,t)}return e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,i.prototype=Object.create(Error.prototype),i.prototype.constructor=i,r.prototype.constructor=r,r.prototype.parse=function(i){var r=this,n=i.toLowerCase().split(";"),s={};return t.each(n,function(t,i){if(0!=i.length){var n=i.split(":");if(2!=n.length)throw new e("wrong rule parameter format: "+i);var o=n[0].trim(),a=n[1].trim();switch(o){case"type":s.type=a;break;case"items":s.items={type:a};break;case"properties":s.properties=r.parseProperties(a);break;case"bind":s.$bind=a;break;default:if(o.length)throw new e("unknown rule parameter: "+o)}}}),this.validate(s),s},r.prototype.parseProperties=function(e){var i=e.split(","),r=0,n={};return t.each(i,function(t,e){var i=e.trim();if(i.length>0){var s=i.split("="),o=s[0].trim();s.length>1?n[o]={type:s[1].trim()}:(n[o]={$target:r},r+=1)}}),n},r.prototype.validate=function(t){if(this.options.validate){var i=/^(null|boolean|number|string|array|object)$/;if(!t.type.match(i))throw new e("unknow type: "+t.type);if("$bind"in t&&!t.$bind.match(/^(default|attr=[a-z]+[a-z0-9_]*|options|content)$/))throw new e("wrong bind method "+t.$bind);if("array"==t.type&&"$bind"in t&&!t.$bind.match(/^(default|options)$/))throw new e("bind method not allowed");if("array"==t.type&&t.items&&(!t.items.type||!t.items.type.match(i)))throw new e("wrong items type: "+t.items.type);if("object"==t.type){if(!t.properties)throw new e('"properties" are required for type object');for(var r in t.properties){if(!r.match(/^[a-z][a-z0-9_\-]*$/))throw new e("wrong object property name: "+r);if(t.properties[r]){var n=t.properties[r];if(n.type&&!n.type.match(i))throw new e("wrong property type: "+n.type)}}if("$bind"in t&&!t.$bind.match(/^(default|content|options)$/))throw new e("bind method not allowed")}}},n.prototype.constructor=n,n.prototype.rule=function(e){var r={type:"string",$bind:"default"};if(1!=e.length)throw new i("unable to create schema for provided element");e.is("[type=number]")&&(r.type="number"),e.is("tbody,ul,ol")&&(r.type="array");var n=e.data(this.options.namespace);return n?t.extend({$bind:"default"},this.ruleParser.parse(n)):r},n.prototype.find=function(t){var e=t.find("[data-$ns]".replace("$ns",this.options.namespace)).first();if(0==t.length)throw new i("one or more child elements is missing");if(null!=t.data(this.options.namespace)||0==e.length)return t;if(e.length>0)return e;throw new i("at least one element descendant have to define bond attibute")},n.prototype.visit=function(t,e){var r=null;switch(e.type){case"null":r=this.visitNull.apply(this,arguments);break;case"boolean":r=this.visitBoolean.apply(this,arguments);break;case"number":r=this.visitNumber.apply(this,arguments);break;case"string":r=this.visitString.apply(this,arguments);break;case"array":r=this.visitArray.apply(this,arguments);break;case"object":r=this.visitObject.apply(this,arguments);break;default:throw new i("unknown type: "+e.type)}return r},n.prototype.traverse=function(t){var e=Array.prototype.slice.call(arguments);return e.splice(1,0,this.rule(t)),this.visit.apply(this,e)},n.prototype.jsonschema=function(e){var r=this.rule(e);if("array"==r.type)if("options"==r.$bind)r.items=t.extend({$bind:"default",type:"string"},r.items);else{var n=e.children(":first-child");if(n.length<1)throw new i("array has to have at least one children");r.items=this.jsonschema(this.find(n))}else if("object"==r.type)for(var s in r.properties){var o=r.properties[s];"$target"in o&&"default"==r.$bind?r.properties[s]=t.extend(o,this.jsonschema(this.find(e.children().eq(o.$target)))):r.properties[s]=t.extend({type:"string"},o)}return r},n.prototype.resolve=function(e,r,n,s){var n=n||function(t,e,i){return null==e},s=s||this.rule(e);if("string"==typeof r&&0==r.indexOf("/")){var o=r.split("/");if(!(o.length>1&&o[1].length))return n.call(this,e,null,s);var a=o[1],p="/"+r.substring(2+a.length);if("array"==s.type){if("options"==s.$bind)return n.call(this,e,null,s);if(e.children().length<1)throw new i("array has to have at least one children");if(n.call(this,e,p,s))return!0;if(t.isNumeric(a)){var h=e.children(":nth("+a+")").next();if(s.items||(s.items=this.jsonschema(this.find(e.children(":first-child")))),h.length)return this.resolve(this.find(h),p,n,s.items)}}if("object"==s.type&&a in s.properties){var l=s.properties[a];if("$target"in l&&"default"==s.$bind){var h=e.children(":nth("+l.$target+")");if(n.call(this,h,p,s))return!0;if(h.length)return"$bind"in l?this.resolve(this.find(h),p,n,l):this.resolve(this.find(h),p,n)}else if(n.call(this,e,null,l))return!0}}return!1},s.prototype=Object.create(n.prototype),s.prototype.constructor=s,s.prototype.visitNull=function(t,e){return null},s.prototype.visitBoolean=function(e,i){if(i.$bind.match(/^attr=.*/))return e.is("[attr]".replace("attr",i.$bind.substr(5)));if(e.is("input[type=checkbox]"))return e.is(":checked");var r=t.trim(this.visitString(e,i));return"true"==r.toLowerCase()},s.prototype.visitNumber=function(e,i){return parseFloat(t.trim(this.visitString(e,i)))},s.prototype.visitString=function(e,i){return i.$bind.match(/^attr=.*/)?t.trim(e.attr(i.$bind.substr(5))):e.is("select:has(option),fieldset:has(input[type=radio])")?e.find(":checked").val():e.is("input,textarea")?e.val():t.trim(e.text())},s.prototype.visitArray=function(e,r){if("options"==r.$bind){var r=t.extend({items:{type:"string"}},r);if(e.is("select[multiple],fieldset:has(input[type=checkbox])"))return e.find("option:selected,input:checked").map(function(e,n){var s=t(n);switch(r.items.type){case"boolean":return"true"==s.val().toLowerCase();case"number":return parseFloat(s.val());case"string":return s.val();default:throw new i("unknown type for array items")}}).get();throw new i("wrong element, have to be select or fieldset")}if(e.children().length<1)throw new i("array has to have at least one children");if(!("items"in r)){var n=this.find(e.children(":first-child"));r=t.extend(r,{items:this.jsonschema(n)})}return e.children(":not(:first-child)").map(function(e,i){return this.visit(this.find(t(i)),r.items)}.bind(this)).get()},s.prototype.visitObject=function(e,r){var n={},s=e.children();for(var o in r.properties){var a=r.properties[o];if("$target"in a)if("content"==r.$bind){if(0!=a.$target)throw new i("more then one property for content bind method");n[o]=e.text()}else{var p=this.find(s.eq(a.$target)),h="$bind"in a?this.visit(p,a):this.traverse(p);null!=h&&(n[o]=h)}else n[o]=this.visit(e,t.extend(a,{$bind:"attr="+o}))}return n},s.prototype.get=function(t,e){var i=null;return this.resolve(t,e,function(t,e,r){return null==e?(i=this.visit(t,r),!0):!1}),i},o.prototype=Object.create(n.prototype),o.prototype.constructor=o,o.prototype.visitNull=function(t,e,i){},o.prototype.visitBoolean=function(t,e,i){if(e.$bind.match(/^attr=.*/))this.visitString(t,e,i);else{if(t.is("input[type=checkbox]"))return t.prop("checked",i);this.visitString(t,e,i)}},o.prototype.visitNumber=function(t,e,i){this.visitString(t,e,i)},o.prototype.visitString=function(e,i,r){i.$bind.match(/^attr=.*/)?e.attr(i.$bind.substr(5),r):e.is("select:has(option)")?e.children("option").each(function(e,i){var n=t(i);n.prop("selected",n.val()==r)}):e.is("fieldset:has(input[type=radio])")?e.find("input[type=radio]").each(function(e,i){var n=t(i);n.prop("checked",n.val()==r)}):e.is("input,textarea")?e.val(r):e.text(r)},o.prototype.visitArray=function(e,r,n){if("options"==r.$bind){var r=t.extend({items:{type:"string"}},r);if(e.is("select[multiple]"))e.val(t.isArray(n)?n:[]);else{if(!e.is("fieldset:has(input[type=checkbox])"))throw new i("wrong element, have to be select or fieldset");e.find("input").val(t.isArray(n)?n:[])}}else{if(e.children().length<1)throw new i("array has to have at least one children");var s=e.children(":first-child");"items"in r||(r=t.extend(r,{items:this.jsonschema(this.find(s))}));var o=e.children(":not(:first-child)");if(t.isArray(n)){if(o.length>n.length)o.slice(n.length).remove();else if(o.length<n.length){var a=s.clone(),p="data-$ns".replace("$ns",this.options.namespace);a.removeAttr("disabled").removeAttr("hidden").show(),a.find("*").add(a).filter("["+p+"]").attr(p,"");for(var h=o.length;h<n.length;h++)e.append(a.clone())}e.children(":not(:first-child)").each(function(e,i){this.visit(this.find(t(i)),r.items,e in n?n[e]:null)}.bind(this))}else o.remove()}},o.prototype.visitObject=function(e,r,n){for(var s in r.properties){var o=r.properties[s],a=n&&s in n?n[s]:null;if("$target"in o)if("content"==r.$bind){if(0!=o.$target)throw new i("more then one property for content bind method");e.text(a)}else{var p=this.find(e.children(":nth("+o.$target+")"));"$bind"in o?this.visit(p,o,a):this.traverse(p,a)}else this.visit(e,t.extend(o,{$bind:"attr="+s}),a)}},o.prototype.patch=function(e,i,r,n){var s=!1;if("replace"==i)s=this.resolve(e,r,function(t,e,i){return null==e?(this.visit(t,i,n),!0):!1});else if("add"==i)s=this.resolve(e,r,function(e,i,r){if(null==i||t.isNumeric(i.substring(1))){var s="data-$ns".replace("$ns",this.options.namespace),o=(i||"/").substring(1),a=e.children(":first-child");r.items||(r.items=this.jsonschema(this.find(a)));var p=a.clone();return p.removeAttr("disabled").removeAttr("hidden").show(),p.find("*").add(p).filter("["+s+"]").attr(s,""),t.isNumeric(o)?e.children(":not(:first-child)").eq(parseInt(o)).before(p):e.append(p),this.visit(this.find(p),r.items,n),!0}return!1});else{if("remove"!=i)throw new Error("unknown patch operation: "+i);s=this.resolve(e,r,function(t,e,i){return null==e?(t.remove(),!0):!1})}return s},t.fn.jbond=function(e){switch(e){case"parse":var i=new s(arguments[1]);return i.traverse(this.first());case"get":var i=new s(arguments[2]);return i.get(this.first(),arguments[1]);case"compose":var r=new o(arguments[2]),a=arguments[1];return this.each(function(){r.traverse(t(this),a)});case"patch":var r=new o(arguments[4]),p=arguments[1],h=arguments[2],a=arguments[3];return this.each(function(){return r.patch(t(this),p,h,a)});default:var l=new n(arguments[1]);return l.jsonschema(this)}},{RuleError:e,SchemaError:i,RuleParser:r,RuleTree:n,TreeParser:s,TreeComposer:o}}(jQuery);
//# sourceMappingURL=dist/jquery.jbond.min.map