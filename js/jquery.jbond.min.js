var jbond=function(t){function e(){var t=Error.apply(this,arguments);this.name="RuleError",this.message=t.message,this.stack=t.stack}function r(){var t=Error.apply(this,arguments);this.name="SchemaError",this.message=t.message,this.stack=t.stack}function i(e){this.options=t.extend({validate:!0},e)}function n(e){this.options=t.extend({namespace:"jbond",RuleParser:i},e),this.ruleParser=new this.options.RuleParser({validate:!1})}function s(t){n.call(this,t)}function o(t){n.call(this,t)}return e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,r.prototype=Object.create(Error.prototype),r.prototype.constructor=r,i.prototype.constructor=i,i.prototype.parse=function(r){var i=this,n=r.toLowerCase().split(";"),s={};return t.each(n,function(t,r){if(0!=r.length){var n=r.split(":");if(2!=n.length)throw new e("wrong rule parameter format: "+r);var o=n[0].trim(),a=n[1].trim();switch(o){case"type":s.type=a;break;case"items":s.items={type:a};break;case"properties":s.properties=i.parseProperties(a);break;case"bind":s.$bind=a;break;default:if(o.length)throw new e("unknown rule parameter: "+o)}}}),this.validate(s),s},i.prototype.parseProperties=function(e){var r=e.split(","),i=0,n={};return t.each(r,function(t,e){var r=e.trim();if(r.length>0){var s=r.split("="),o=s[0].trim();s.length>1?n[o]={type:s[1].trim(),$bind:"attr="+o}:(n[o]={$target:i},i+=1)}}),n},i.prototype.validate=function(t){if(this.options.validate){var r=/^(null|boolean|number|string|array|object)$/;if(!t.type.match(r))throw new e("unknow type: "+t.type);if("$bind"in t&&!t.$bind.match(/^(default|attr=[a-z]+[a-z0-9_]*|options|content)$/))throw new e("wrong bind method "+t.$bind);if("array"==t.type&&"$bind"in t&&!t.$bind.match(/^(default|options)$/))throw new e("bind method not allowed");if("array"==t.type&&t.items&&(!t.items.type||!t.items.type.match(r)))throw new e("wrong items type: "+t.items.type);if("object"==t.type){if(!t.properties)throw new e('"properties" are required for type object');for(var i in t.properties){if(!i.match(/^[a-z][a-z0-9_\-]*$/))throw new e("wrong object property name: "+i);if(t.properties[i]){var n=t.properties[i];if(n.type&&!n.type.match(r))throw new e("wrong property type: "+n.type)}}if("$bind"in t&&!t.$bind.match(/^(default|content)$/))throw new e("bind method not allowed")}}},n.prototype.constructor=n,n.prototype.rule=function(e){var i={type:"string",$bind:"default"};if(1!=e.length)throw new r("unable to create schema for provided element");e.is("[type=number]")&&(i.type="number"),e.is("tbody,ul,ol")&&(i.type="array");var n=e.data(this.options.namespace);return n?t.extend({$bind:"default"},this.ruleParser.parse(n)):i},n.prototype.find=function(t){var e=t.find("[data-$ns]".replace("$ns",this.options.namespace)).first();if(0==t.length)throw new r("one or more child elements is missing");if(null!=t.data(this.options.namespace)||0==e.length)return t;if(e.length>0)return e;throw new r("at least one element descendant have to define bond attibute")},n.prototype.visit=function(t,e){var i=null;switch(e.type){case"null":i=this.visitNull.apply(this,arguments);break;case"boolean":i=this.visitBoolean.apply(this,arguments);break;case"number":i=this.visitNumber.apply(this,arguments);break;case"string":i=this.visitString.apply(this,arguments);break;case"array":i=this.visitArray.apply(this,arguments);break;case"object":i=this.visitObject.apply(this,arguments);break;default:throw new r("unknown type: "+e.type)}return i},n.prototype.traverse=function(t){var e=Array.prototype.slice.call(arguments);return e.splice(1,0,this.rule(t)),this.visit.apply(this,e)},n.prototype.jsonschema=function(e){var i=this.rule(e);if("array"==i.type)if("options"==i.$bind)i.items=t.extend({$bind:"default",type:"string"},i.items);else{var n=e.children(":first-child");if(n.length<1)throw new r("array has to have at least one children");i.items=this.jsonschema(this.find(n))}else if("object"==i.type)for(var s in i.properties){var o=i.properties[s];"$target"in o&&"default"==i.$bind?i.properties[s]=t.extend(o,this.jsonschema(this.find(e.children().eq(o.$target)))):i.properties[s]=t.extend({type:"string"},o)}return i},s.prototype=Object.create(n.prototype),s.prototype.constructor=s,s.prototype.visitNull=function(t,e){return null},s.prototype.visitBoolean=function(e,r){if(r.$bind.match(/^attr=.*/))return e.is("[attr]".replace("attr",r.$bind.substr(5)));if(e.is("input[type=checkbox]"))return e.is(":checked");var i=t.trim(this.visitString(e,r));return"true"==i.toLowerCase()},s.prototype.visitNumber=function(e,r){return parseFloat(t.trim(this.visitString(e,r)))},s.prototype.visitString=function(e,r){return r.$bind.match(/^attr=.*/)?t.trim(e.attr(r.$bind.substr(5))):e.is("select:has(option),fieldset:has(input[type=radio])")?e.find(":checked").val():e.is("input,textarea")?e.val():t.trim(e.text())},s.prototype.visitArray=function(e,i){if("options"==i.$bind){var i=t.extend({items:{type:"string"}},i);if(e.is("select[multiple],fieldset:has(input[type=checkbox])"))return e.find("option:selected,input:checked").map(function(e,n){var s=t(n);switch(i.items.type){case"boolean":return"true"==s.val().toLowerCase();case"number":return parseFloat(s.val());case"string":return s.val();default:throw new r("unknown type for array items")}}).get();throw new r("wrong element, have to be select or fieldset")}if(e.children().length<1)throw new r("array has to have at least one children");if(!("items"in i)){var n=this.find(e.children(":first-child"));i=t.extend(i,{items:this.jsonschema(n)})}return e.children(":not(:first-child)").map(function(e,r){return this.visit(this.find(t(r)),i.items)}.bind(this)).get()},s.prototype.visitObject=function(t,e){var i={},n=t.children();for(var s in e.properties){var o=e.properties[s];if("$target"in o)if("content"==e.$bind){if(0!=o.$target)throw new r("more then one property for content bind method");i[s]=t.text()}else{var a=this.find(n.eq(o.$target));"$bind"in o?i[s]=this.visit(a,o):i[s]=this.traverse(a)}else i[s]=this.visit(t,o)}return i},o.prototype=Object.create(n.prototype),o.prototype.constructor=o,o.prototype.visitNull=function(t,e,r){},o.prototype.visitBoolean=function(t,e,r){if(e.$bind.match(/^attr=.*/))this.visitString(t,e,r);else{if(t.is("input[type=checkbox]"))return t.prop("checked",r);this.visitString(t,e,r)}},o.prototype.visitNumber=function(t,e,r){this.visitString(t,e,r)},o.prototype.visitString=function(e,r,i){r.$bind.match(/^attr=.*/)?e.attr(r.$bind.substr(5),i):e.is("select:has(option)")?e.children("option").each(function(e,r){var n=t(r);n.prop("selected",n.val()==i)}):e.is("fieldset:has(input[type=radio])")?e.find("input[type=radio]").each(function(e,r){var n=t(r);n.prop("checked",n.val()==i)}):e.is("input,textarea")?e.val(i):e.text(i)},o.prototype.visitArray=function(e,i,n){if("options"==i.$bind){var i=t.extend({items:{type:"string"}},i);if(e.is("select[multiple]"))e.val(t.isArray(n)?n:[]);else{if(!e.is("fieldset:has(input[type=checkbox])"))throw new r("wrong element, have to be select or fieldset");e.find("input").val(t.isArray(n)?n:[])}}else{if(e.children().length<1)throw new r("array has to have at least one children");var s=e.children(":first-child");"items"in i||(i=t.extend(i,{items:this.jsonschema(this.find(s))}));var o=e.children(":not(:first-child)");if(t.isArray(n)){if(o.length>n.length)o.slice(n.length).remove();else if(o.length<n.length){var a=s.clone(),p="data-$ns".replace("$ns",this.options.namespace);a.removeAttr("disabled").removeAttr("hidden").show(),a.find("*").add(a).filter("["+p+"]").attr(p,"");for(var h=o.length;h<n.length;h++)e.append(a.clone())}e.children(":not(:first-child)").each(function(e,r){this.visit(this.find(t(r)),i.items,e in n?n[e]:null)}.bind(this))}else o.remove()}},o.prototype.visitObject=function(t,e,i){var n=t.children();for(var s in e.properties){var o=e.properties[s],a=i&&s in i?i[s]:null;if("$target"in o)if("content"==e.$bind){if(0!=o.$target)throw new r("more then one property for content bind method");t.text(a)}else{var p=this.find(n.eq(o.$target));"$bind"in o?this.visit(p,o,a):this.traverse(p,a)}else this.visit(t,o,a)}},o.prototype.patch=function(e,r,i,n,s){if(!s)var s=this.rule(e);if("string"==typeof i&&0==i.indexOf("/")){var o=i.split("/");if(o.length>1&&(o[1].length||"add"==r)){var a=o[1],p="/"+i.substring(2+a.length);if("array"==s.type&&"default"==s.$bind){if(e.children().length<1)throw new Error("array has to have at least one children");var h=e.children(":not(:first-child)");if("remove"==r&&t.isNumeric(a))return void h.eq(parseInt(a)).remove();var c=e.children(":first-child");if(s.items||(s.items=this.jsonschema(this.find(c))),"add"==r){var l="data-$ns".replace("$ns",this.options.namespace),d=c.clone();return d.removeAttr("disabled").removeAttr("hidden").show(),d.find("*").add(d).filter("["+l+"]").attr(l,""),t.isNumeric(a)?h.eq(parseInt(a)).before(d):e.append(d),this.visit(d,s.items,n)}if(t.isNumeric(a)){var f=parseInt(a);return this.patch(this.find(h.eq(f)),r,p,n,s.items)}}if("object"==s.type&&"default"==s.$bind&&a in s.properties){var u=s.properties[a];if("$target"in u){var v=e.children().eq(u.$target);return"$bind"in u?this.patch(this.find(v),r,p,n,u):this.patch(this.find(v),r,p,n)}}throw new Error("unresolved path: "+i)}if("replace"==r)return this.visit(e,s,n);throw new Error("wrong patch operation: "+r+" for type: "+s.type)}throw new Error("wrong path: "+i)},t.fn.jbond=function(t){switch(t){case"parse":var e=new s(arguments[1]);return e.traverse(this);case"compose":var r=new o(arguments[2]);return r.traverse(this,arguments[1]);case"patch":var r=new o(arguments[2]);return r.patch(this,arguments[1],arguments[2],arguments[3],arguments[4]);default:var i=new n(arguments[1]);return i.jsonschema(this)}},{RuleError:e,SchemaError:r,RuleParser:i,RuleTree:n,TreeParser:s,TreeComposer:o}}(jQuery);
//# sourceMappingURL=dist/jquery.jbond.min.map